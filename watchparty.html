<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch Party Room</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #nickname-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
    #nickname-form { background: white; padding: 20px; border-radius: 5px; }
    #nickname-input { padding: 5px; margin-right: 10px; }
    #watchparty-container { display: flex; height: 100vh; }
    #video-player { flex: 3; }
    #video-player iframe { width: 100%; height: 100%; border: none; }
    #chat-container { flex: 1; display: flex; flex-direction: column; border-left: 1px solid #ccc; }
    #chat-messages { flex: 1; overflow-y: auto; padding: 10px; background-color: #000; color: #fff;}
    #chat-form { background-color: #e90000; padding: 10px; border-top: 2px solid #fff; }
    #chat-input {background-color: #000; color: #fff; border: none; width: 70%; padding: 5px; }
  </style>
</head>
<body>
  <div id="nickname-modal">
    <form id="nickname-form">
      <input type="text" id="nickname-input" placeholder="닉네임 입력 (최대 10자, 한/영)" required />
      <button type="submit">참여</button>
    </form>
  </div>
  <div id="watchparty-container" style="display: none;">
    <div id="video-player"></div>
    <div id="chat-container">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <input type="text" id="chat-input" placeholder="메시지 입력" />
        <button type="submit">전송</button>
      </form>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://hthtzipxhfezjduxskzg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0aHR6aXB4aGZlempkdXhza3pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MTE1MzQsImV4cCI6MjA1NzQ4NzUzNH0.e-SodT9c9kv6Gm4HytAjYoIvnOfQTvFBFzLTiGFaxwg';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const roomId = new URLSearchParams(window.location.search).get('room');
    let nickname = '';
    let player;

    // 닉네임 입력 처리
    document.getElementById('nickname-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const inputNickname = document.getElementById('nickname-input').value.trim();
      if (inputNickname.length > 10 || !/^[a-zA-Z가-힣]+$/.test(inputNickname)) {
        alert('닉네임은 1-10자, 한글 또는 영문만 가능합니다.');
        return;
      }
      const { data, error } = await supabaseClient.from('watchparty_messages').select('nickname').eq('room_id', roomId);
      if (error) {
        console.error('닉네임 확인 오류:', error);
        return;
      }
      const existingNicknames = data.map(msg => msg.nickname);
      if (existingNicknames.includes(inputNickname)) {
        alert('이미 사용 중인 닉네임입니다. 다른 닉네임을 선택하세요.');
        return;
      }
      nickname = inputNickname;
      document.getElementById('nickname-modal').style.display = 'none';
      document.getElementById('watchparty-container').style.display = 'flex';
      joinWatchParty();
    });

    async function joinWatchParty() {
      // 영상 로드
      const { data: room, error } = await supabaseClient.from('watchparty_rooms').select('video_url').eq('id', roomId).single();
      if (error || !room) {
        alert('방을 찾을 수 없습니다.');
        return;
      }
      const videoId = extractVideoId(room.video_url);
      loadYouTubePlayer(videoId);

      // 기존 채팅 메시지 로드
      const { data: messages, error: msgError } = await supabaseClient.from('watchparty_messages').select('*').eq('room_id', roomId).order('created_at', { ascending: true });
      if (msgError) {
        console.error('메시지 로드 오류:', msgError);
        return;
      }
      messages.forEach(msg => displayMessage(msg));

      // 실시간 채팅 구독
      supabaseClient
        .channel(`watchparty_messages:room_id=eq.${roomId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'watchparty_messages', filter: `room_id=eq.${roomId}` }, payload => {
          displayMessage(payload.new);
        })
        .subscribe();

      // 채팅 메시지 전송
      document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageText = document.getElementById('chat-input').value.trim();
        if (!messageText) return;
        await supabaseClient.from('watchparty_messages').insert({ room_id: roomId, nickname, message_text: messageText });
        document.getElementById('chat-input').value = '';
      });

      // 실시간 영상 동기화 구독
      supabaseClient
        .channel(`watchparty_sync:room_id=eq.${roomId}`)
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'watchparty_sync', filter: `room_id=eq.${roomId}` }, payload => {
          const { current_time, is_playing } = payload.new;
          if (player) {
            player.seekTo(current_time, true);
            if (is_playing) {
              player.playVideo();
            } else {
              player.pauseVideo();
            }
          }
        })
        .subscribe();
    }

    function loadYouTubePlayer(videoId) {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      window.onYouTubeIframeAPIReady = () => {
        player = new YT.Player('video-player', {
          height: '100%',
          width: '100%',
          videoId: videoId,
          playerVars: {
            'controls': 0, // 컨트롤 숨기기
            'disablekb': 1, // 키보드 제어 비활성화
            'fs': 0, // 전체화면 버튼 비활성화
            'modestbranding': 1,
            'rel': 0,
            'showinfo': 0,
            'iv_load_policy': 3
          },
          events: {
            'onReady': onPlayerReady
          }
        });
      };
    }

    function onPlayerReady(event) {
      event.target.setVolume(50); // 초기 볼륨 설정
    }

    function displayMessage(message) {
      const chatMessages = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.textContent = `${message.nickname}: ${message.message_text}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function extractVideoId(url) {
      const regex = /(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/|live\/))([\w-]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }
  </script>
</body>
</html>