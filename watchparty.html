<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch Party Room</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
  <style>
    body {font-family: "Open Sans", sans-serif; margin: 0; padding: 0; background-color: #000; color: #fff; }
    #nickname-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
    #nickname-form { background: white; padding: 20px; border-radius: 5px; }
    #nickname-input { padding: 5px; margin-right: 10px; }
    #watchparty-container { display: flex; height: 100vh; }
    #video-player {display: flex; flex: 3; position: relative; justify-content: center;}
    #video-player iframe { width: 100%; height: 95.12%; border: none; }
    #video-player iframe .ytp-endscreen-content, #video-player iframe .ytp-pause-overlay { display: none !important; }
    #sync-message { 
      position: absolute; 
      top: 10px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #e90000fa; 
      padding: 8px 16px; 
      border-radius: 5px; 
      font-size: clamp(12px, 1vw, 24px); 
      color: #fff; 
      opacity: 0; 
      transition: opacity 0.3s ease; 
    }
    #sync-message.visible { opacity: 1; }
    #controls {background-color: #e90000; width: 100%; position: absolute; bottom: 0; display: flex; align-items: center; padding: 8px 0; border-top: solid 2px #fff; justify-content: space-between; }
    #volume-slider { margin-left: 20px; width: 100px; }
    #sync-button { font-family: "Nanum Gothic", sans-serif; background-color: #e90000; padding: 4.5px 10px; color: #fff; border: solid 2px #fff; border-radius: 4px; cursor: pointer; margin-right: 20px;}
    #chat-container { flex: 1; display: flex; flex-direction: column; border-left: 2px solid #fff; }
    #chat-messages {font-family: "Nanum Gothic", sans-serif; font-weight: 400; font-size: clamp(12px, 0.8vw, 18px); flex: 1; overflow-y: auto; padding: 10px; background-color: #000; color: #fff; display: flex; flex-direction: column; justify-content: flex-end; }
    #chat-form {display: flex; justify-content: space-around; background-color: #e90000; padding: 10px; border-top: 2px solid #fff; }
    #chat-input { width: 600%; background-color: #000; color: #fff; border: none; padding: 5px; }
    @media screen and (max-width: 767px) {
        #video-player { flex: 1.6; }
        #watchparty-container { flex-direction: column; }
        #chat-container { border-left: none; border-top: solid 2px #fff; }
    }
    
    @media only screen and (max-width: 767px) and (pointer: coarse) and (orientation: portrait) {
      #video-player .non_click_overlay { display: none; }
    }

    .system-message {
      font-weight: 100;
      font-size: clamp(10px, 0.6vw, 18px);
      color: #e90000;
      text-align: center;
      width: 100%;
      margin: 8px 0;
      font-style: italic;
    }

  </style>
</head>
<body>
  <div id="nickname-modal">
    <form id="nickname-form">
      <input type="text" id="nickname-input" placeholder="닉네임 입력 (최대 10자, 한/영)" required />
      <button type="submit">참여</button>
    </form>
  </div>
  <div id="watchparty-container" style="display: none;">
    <div id="video-player">
      <div class="non_click_overlay" style="width: 100%; height: 100%; position: absolute;"></div>
      <div id="sync-message">영상 시작 이후 접속하신 경우 우측 동기화 버튼을 눌러주세요.</div>
      <div id="player"></div>
      <div id="controls">
        <input type="range" id="volume-slider" min="0" max="100" value="50">
        <button id="sync-button">동기화</button>
      </div>
    </div>
    <div id="chat-container">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <input type="text" id="chat-input" placeholder="메시지 입력" />
        <button type="submit" style="background-color: #e90000; border: none; color: #fff; font-weight: bold; width: 100%;">Send</button>
      </form>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://hthtzipxhfezjduxskzg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0aHR6aXB4aGZlempkdXhza3pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MTE1MzQsImV4cCI6MjA1NzQ4NzUzNH0.e-SodT9c9kv6Gm4HytAjYoIvnOfQTvFBFzLTiGFaxwg';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const roomId = new URLSearchParams(window.location.search).get('room');
    let nickname = sessionStorage.getItem('nickname') || '';
    let player;
    let syncInterval;

    if (nickname) {
      document.getElementById('nickname-modal').style.display = 'none';
      document.getElementById('watchparty-container').style.display = 'flex';
      joinWatchParty();
    } else {
      document.getElementById('nickname-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const inputNickname = document.getElementById('nickname-input').value.trim();
        if (inputNickname.length > 10 || !/^[a-zA-Z가-힣]+$/.test(inputNickname)) {
          alert('닉네임은 1-10자, 한글 또는 영문만 가능합니다.');
          return;
        }
        const { data, error } = await supabaseClient.from('watchparty_messages').select('nickname').eq('room_id', roomId);
        if (error) {
          console.error('닉네임 확인 오류:', error);
          return;
        }
        const existingNicknames = data.map(msg => msg.nickname);
        if (existingNicknames.includes(inputNickname)) {
          alert('이미 사용 중인 닉네임입니다. 다른 닉네임을 선택하세요.');
          return;
        }
        nickname = inputNickname;
        sessionStorage.setItem('nickname', nickname);
        document.getElementById('nickname-modal').style.display = 'none';
        document.getElementById('watchparty-container').style.display = 'flex';
        joinWatchParty();
      });
    }

    async function joinWatchParty() {
      const { data: room, error } = await supabaseClient.from('watchparty_rooms').select('video_url').eq('id', roomId).single();
      if (error || !room) {
        alert('방을 찾을 수 없습니다.');
        return;
      }
      const videoId = extractVideoId(room.video_url);
      loadYouTubePlayer(videoId);

      const { data: messages, error: msgError } = await supabaseClient.from('watchparty_messages').select('*').eq('room_id', roomId).order('created_at', { ascending: true });
      if (msgError) {
        console.error('메시지 로드 오류:', msgError);
        return;
      }
      messages.forEach(msg => displayMessage(msg));

      const messageChannel = supabaseClient
        .channel(`watchparty_messages_channel_${roomId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'watchparty_messages',
          filter: `room_id=eq.${roomId}`
        }, ({ new: newMsg }) => {
          displayMessage(newMsg);
        });
      await messageChannel.subscribe();

      // System join message
      const { data: sysData, error: sysError } = await supabaseClient
        .from('watchparty_messages')
        .insert({
          room_id: roomId,
          nickname: 'System',
          message_text: `\"${nickname}\"님이 접속하셨습니다.`
        })
        .select();
      if (sysData && sysData.length) displayMessage(sysData[0]);

      document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageText = document.getElementById('chat-input').value.trim();
        if (!messageText) return;
        await supabaseClient.from('watchparty_messages').insert({ room_id: roomId, nickname, message_text: messageText });
        document.getElementById('chat-input').value = '';
      });

      supabaseClient
        .channel(`watchparty_sync:room_id=eq.${roomId}`)
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'watchparty_sync',
          filter: `room_id=eq.${roomId}`
        }, ({ new: sync }) => {
          const { video_time, is_playing } = sync;
          if (player) {
            const current = player.getCurrentTime();
            if (Math.abs(current - video_time) > 1) {
              player.seekTo(video_time, true);
            }
            if (is_playing && player.getPlayerState() !== YT.PlayerState.PLAYING) {
              player.playVideo();
            } else if (!is_playing && player.getPlayerState() === YT.PlayerState.PLAYING) {
              player.pauseVideo();
            }
          }
        })
        .subscribe();
    }

    function loadYouTubePlayer(videoId) {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      window.onYouTubeIframeAPIReady = () => {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId,
          playerVars: {
            controls: 0, disablekb: 1, fs: 0,
            modestbranding: 1, rel: 0, showinfo: 0,
            iv_load_policy: 3, playsinline: 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      };
    }

    function onPlayerReady(event) {
      event.target.setVolume(50);

      // 1초마다 서버에 동기화 정보 전송
      syncInterval = setInterval(syncToServer, 1000);

      document.getElementById('volume-slider').addEventListener('input', e => {
        player.setVolume(e.target.value);
      });
      document.getElementById('sync-button').addEventListener('click', syncFromServer);

      // 초기 동기화
      syncFromServer();
    }

    function onPlayerStateChange(event) {
      // 상태 변할 때 즉시 동기화
      syncToServer();
      const syncMessage = document.getElementById('sync-message');
      if (event.data === YT.PlayerState.PLAYING) {
        syncMessage.classList.remove('visible');
      } else {
        syncMessage.classList.add('visible');
      }
    }

    // 서버에 현재 시간과 상태 upsert
    async function syncToServer() {
      if (!player) return;
      const video_time = player.getCurrentTime();
      const is_playing = (player.getPlayerState() === YT.PlayerState.PLAYING);
      const { error } = await supabaseClient
        .from('watchparty_sync')
        .upsert({ room_id: roomId, video_time, is_playing }, { onConflict: 'room_id' });
      if (error) console.error('Sync upsert error:', error);
    }

    // 서버의 최신 동기화 정보 불러오기
    async function syncFromServer() {
      const { data, error } = await supabaseClient
        .from('watchparty_sync')
        .select('*')
        .eq('room_id', roomId)
        .single();
      if (data && !error && player) {
        player.seekTo(data.video_time, true);
        if (data.is_playing) player.playVideo();
        else player.pauseVideo();
      }
    }

    function displayMessage(message) {
      const chatMessages = document.getElementById('chat-messages');
      const div = document.createElement('div');
      if (message.nickname === 'System') {
        div.className = 'system-message';
        div.textContent = `<System: ${message.message_text}>`;
      } else {
        div.textContent = `${message.nickname}: ${message.message_text}`;
      }
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function extractVideoId(url) {
      const regex = /(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/|live\/))([\w-]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }
  </script>
</body>
</html>
