<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch Party Room</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Open Sans", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
      overflow: hidden; /* 페이지 스크롤 방지 */
    }
    #nickname-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #nickname-form {
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    #nickname-input {
      padding: 5px;
      margin-right: 10px;
    }
    #watchparty-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #video-player {
      display: flex;
      flex: 3;
      position: relative;
      justify-content: center;
    }
    #video-player iframe {
      width: 100%;
      height: 95.12%;
      border: none;
    }
    #video-player iframe .ytp-endscreen-content,
    #video-player iframe .ytp-pause-overlay {
      display: none !important;
    }
    #sync-message {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #e90000fa;
      padding: 8px 16px;
      border-radius: 5px;
      font-size: clamp(12px, 1vw, 24px);
      color: #fff;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #sync-message.visible {
      opacity: 1;
    }
    #controls {
      background-color: #e90000;
      width: 100%;
      position: absolute;
      bottom: 0;
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-top: solid 2px #fff;
      justify-content: space-between;
    }
    #volume-control {
      display: flex;
      align-items: center;
      margin-left: 10px;
    }
    #volume-speaker {
      width: 34px;
      height: 24px;
      margin-right: 10px;
    }
    #volume-bars {
      display: flex;
    }
    .volume-bar {
      width: 10px;
      height: 20px;
      background-color: #a70000;
      margin-right: 2px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .volume-bar.active {
      background-color: #fff;
    }
    #sync-button {
      transition: background-color 0.4s;
      font-family: "Nanum Gothic", sans-serif;
      background-color: #e90000;
      padding: 4.5px 10px;
      color: #fff;
      border: solid 2px #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 20px;
      font-weight: bold;
    }
    #sync-button:hover {
      background-color: #fff;
      color: #e90000;
    }
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #fff;
    }
    #chat-messages {
      font-family: "Nanum Gothic", sans-serif;
      font-weight: 400;
      font-size: clamp(12px, 0.8vw, 18px);
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #000;
      color: #fff;
      min-height: 0;
    }
    #chat-messages > div {
      margin-bottom: 8px; /* 메시지 간 간격 */
    }
    #chat-form {
      display: flex;
      justify-content: space-around;
      background-color: #e90000;
      border-top: 2px solid #fff;
      flex-shrink: 0;
    }
    #chat-input {
      height: 35px;
      width: 600%;
      background-color: #000;
      color: #fff;
      border: none;
      padding: 5px;
    }
    /* 커스텀 스크롤바 스타일 */
    #chat-messages::-webkit-scrollbar {
      width: 4px;
    }
    #chat-messages::-webkit-scrollbar-track {
      background: #000;
    }
    #chat-messages::-webkit-scrollbar-thumb {
      background: #e90000;
    }
    @media screen and (max-width: 767px) {
      #video-player {
        flex: 1.6;
      }
      #watchparty-container {
        flex-direction: column;
      }
      #chat-container {
        border-left: none;
        border-top: solid 2px #fff;
      }
    }
    @media only screen and (max-width: 767px) and (pointer: coarse) and (orientation: portrait) {
      #video-player .non_click_overlay {
        display: none;
      }
    }

    #waiting-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(233, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: clamp(24px, 2vw, 34px);
      font-weight: bold;
      text-align: center;
      z-index: 10;
    }

    #thumbnail-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .system-message {
      font-weight: 100;
      font-size: clamp(10px, 0.6vw, 18px);
      color: #e90000;
      text-align: center;
      width: 100%;
      margin: 8px 0;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="nickname-modal">
    <form id="nickname-form">
      <input type="text" id="nickname-input" placeholder="닉네임 입력 (최대 10자, 한/영/숫자)" required autocomplete='off'/>
      <button type="submit">참여</button>
    </form>
  </div>
  <div id="watchparty-container" style="display: none;">
    <div id="video-player">
      <div class="non_click_overlay" style="width: 100%; height: 100%; position: absolute;"></div>
      <div id="waiting-overlay" style="display: none; flex-direction: column;">
        <img src="./logo.png" style="width: 100%; max-width: 240px; margin-bottom: 30px;">
        <div>송출 대기중 입니다.</div>
      </div>
      <div id="sync-message">영상 시작 이후 접속하신 경우 우측 동기화 버튼을 눌러주세요.</div>
      <div id="player"></div>
      <div id="thumbnail-container" style="display: none;">
        <img id="thumbnail-img" src="" alt="Video Thumbnail" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.5;" />
      </div>
      <div id="controls">
        <div id="volume-control">
          <svg id="volume-speaker" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
            <path id="wave1" d="M15.54 8.46a5 5 0 0 1 0 7.08" style="display: none;"/>
            <path id="wave2" d="M18.54 5.46a8.5 8.5 0 0 1 0 12.08" style="display: none;"/>
            <path id="wave3" d="M21.54 2.46a12 12 0 0 1 0 16.08" style="display: none;"/>
          </svg>
          <div id="volume-bars">
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
          </div>
        </div>
        <button id="sync-button">Sync</button>
      </div>
    </div>
    <div id="chat-container">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <input type="text" id="chat-input" placeholder="메시지 입력" autocomplete='off' />
        <button type="submit" style="background-color: #e90000; border: none; color: #fff; font-weight: bold; width: 100%;">Send</button>
      </form>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
const { createClient } = supabase;
const supabaseUrl = 'https://hthtzipxhfezjduxskzg.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0aHR6aXB4aGZlempkdXhza3pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MTE1MzQsImV4cCI6MjA1NzQ4NzUzNH0.e-SodT9c9kv6Gm4HytAjYoIvnOfQTvFBFzLTiGFaxwg';
const supabaseClient = createClient(supabaseUrl, supabaseKey);

let roomId;
async function getRoomIdFromRoomName() {
  const roomName = new URLSearchParams(window.location.search).get('room');
  const { data, error } = await supabaseClient.from('watchparty_rooms').select('id').eq('room_name', roomName).single();
  if (error || !data) {
    alert('방을 찾을 수 없습니다.');
    return null;
  }
  return data.id;
}
let nickname = sessionStorage.getItem('nickname') || '';
let player;
let syncInterval;

(async () => {
  if (nickname) {
    document.getElementById('nickname-modal').style.display = 'none';
    document.getElementById('watchparty-container').style.display = 'flex';
    roomId = await getRoomIdFromRoomName();
    if (!roomId) return;
    joinWatchParty();
  }
})();

document.getElementById('nickname-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const inputNickname = document.getElementById('nickname-input').value.trim();
  if (inputNickname.toLowerCase() === 'system') {
    alert('닉네임으로 "System"은 사용할 수 없습니다.');
    return;
  }
  if (inputNickname.length > 10 || !/^[a-zA-Z가-힣0-9]+$/.test(inputNickname)) {
    alert('닉네임은 1-10자, 한글, 영문, 숫자만 가능합니다.');
    return;
  }
  roomId = await getRoomIdFromRoomName();
  if (!roomId) return;
  const { data, error } = await supabaseClient.from('watchparty_messages').select('nickname').eq('room_id', roomId);
  if (error) {
    console.error('닉네임 확인 오류:', error);
    return;
  }
  const existingNicknames = data.map(msg => msg.nickname);
  if (existingNicknames.includes(inputNickname)) {
    alert('이미 사용 중인 닉네임입니다. 다른 닉네임을 선택하세요.');
    return;
  }
  nickname = inputNickname;
  sessionStorage.setItem('nickname', nickname);
  document.getElementById('nickname-modal').style.display = 'none';
  document.getElementById('watchparty-container').style.display = 'flex';
  joinWatchParty();
});

async function joinWatchParty() {
  const { data: room, error } = await supabaseClient.from('watchparty_rooms').select('video_url, is_reserved, is_active').eq('id', roomId).single();
  if (error || !room) {
    alert('방을 찾을 수 없습니다.');
    return;
  }

  const waitingOverlay = document.getElementById('waiting-overlay');
  const thumbnailContainer = document.getElementById('thumbnail-container');
  const thumbnailImg = document.getElementById('thumbnail-img');
  if (room.is_reserved && !room.is_active) {
    waitingOverlay.style.display = 'flex';
    thumbnailContainer.style.display = 'block';
    const videoId = extractVideoId(room.video_url);
    thumbnailImg.src = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
  } else {
    waitingOverlay.style.display = 'none';
    thumbnailContainer.style.display = 'none';
    const videoId = extractVideoId(room.video_url);
    loadYouTubePlayer(videoId);
    // 서버 동기화 데이터 확인 후 플레이어 상태 설정
    supabaseClient.from('watchparty_sync').select('*').eq('room_id', roomId).single().then(({ data, error }) => {
      if (data && !error && player) {
        player.seekTo(data.video_time, true);
        if (!data.is_playing) {
          player.pauseVideo(); // 초기 상태를 일시정지로 설정
        }
      }
    });
  }

  // 채팅 메시지 로드
  const { data: messages, error: msgError } = await supabaseClient.from('watchparty_messages').select('*').eq('room_id', roomId).order('created_at', { ascending: true });
  if (msgError) {
    console.error('메시지 로드 오류:', msgError);
    return;
  }
  messages.forEach(msg => displayMessage(msg));
  const chatMessages = document.getElementById('chat-messages');
  chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });

  // 채팅 메시지 실시간 구독
  const messageChannel = supabaseClient
    .channel(`watchparty_messages_channel_${roomId}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'watchparty_messages',
        filter: `room_id=eq.${roomId}`,
      },
      ({ new: newMsg }) => {
        console.log('[Realtime] new message arrived:', newMsg);
        displayMessage(newMsg);
      }
    );

  await messageChannel.subscribe();

  // 시스템 메시지 삽입
  const { data: sysData, error: sysError } = await supabaseClient
    .from('watchparty_messages')
    .insert({
      room_id: roomId,
      nickname: 'System',
      message_text: `\"${nickname}\"님이 접속하셨습니다.`
    })
    .select();

  if (sysError) {
    console.error('[System INSERT Error]', sysError);
  } else if (sysData && sysData.length > 0) {
    console.log('[System] inserted:', sysData[0]);
    displayMessage(sysData[0]);
  }

  // 채팅 입력 폼 이벤트 리스너
  document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const messageText = document.getElementById('chat-input').value.trim();
    if (!messageText) return;
    await supabaseClient.from('watchparty_messages').insert({ room_id: roomId, nickname, message_text: messageText });
    document.getElementById('chat-input').value = '';
  });

// 실시간 방 상태 구독
  let syncChannel = null; // 동기화 구독 채널 변수 추가
  supabaseClient
    .channel(`watchparty_room_status_${roomId}`)
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'watchparty_rooms',
        filter: `id=eq.${roomId}`,
      },
      (payload) => {
        const { is_active, is_reserved, video_url } = payload.new;
        if (!is_reserved && is_active) {
          waitingOverlay.style.display = 'none';
          thumbnailContainer.style.display = 'none';
          const videoId = extractVideoId(video_url);
          loadYouTubePlayer(videoId);

          // 비디오 싱크 구독 추가 (중복 방지)
          if (!syncChannel) {
            syncChannel = supabaseClient
              .channel(`watchparty_sync:room_id=eq.${roomId}`)
              .on(
                'postgres_changes',
                {
                  event: 'UPDATE',
                  schema: 'public',
                  table: 'watchparty_sync',
                  filter: `room_id=eq.${roomId}`,
                },
                (payload) => {
                  const { video_time, is_playing } = payload.new;
                  if (player) {
                    const currentTime = player.getCurrentTime();
                    if (Math.abs(currentTime - video_time) > 2) {
                      player.seekTo(video_time, true);
                    }
                    if (is_playing && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                      player.playVideo();
                    } else if (!is_playing && player.getPlayerState() === YT.PlayerState.PLAYING) {
                      player.pauseVideo();
                    }
                  }
                }
              );
            syncChannel.subscribe();
          }
        }
      }
    )
    .subscribe();

  // 비디오 싱크 구독
  if (!room.is_reserved || room.is_active) {
    supabaseClient
      .channel(`watchparty_sync:room_id=eq.${roomId}`)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'watchparty_sync', filter: `room_id=eq.${roomId}` }, payload => {
        const { video_time, is_playing } = payload.new;
        if (player) {
          const currentTime = player.getCurrentTime();
          if (Math.abs(currentTime - video_time) > 2) {
            player.seekTo(video_time, true);
          }
          if (is_playing && player.getPlayerState() !== YT.PlayerState.PLAYING) {
            player.playVideo();
          } else if (!is_playing && player.getPlayerState() === YT.PlayerState.PLAYING) {
            player.pauseVideo();
          }
        }
      })
      .subscribe();
  }
  window.addEventListener('beforeunload', () => {
  if (syncChannel) {
    supabaseClient.removeChannel(syncChannel);
  }
});
}
function turnOffCaptions() {
  if (player && player.setOption) {
    player.setOption('captions', 'track', {});
  }
}

function loadYouTubePlayer(videoId) {
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  const firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  window.onYouTubeIframeAPIReady = () => {
    player = new YT.Player('player', {
      height: '100%',
      width: '100%',
      videoId: videoId,
      playerVars: {
        'controls': 0,
        'disablekb': 1,
        'fs': 0,
        'modestbranding': 1,
        'rel': 0,
        'showinfo': 0,
        'iv_load_policy': 3,
        'playsinline': 1
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  };
}

function onPlayerReady(event) {
  event.target.setVolume(50);
  const volumeBars = document.querySelectorAll('.volume-bar');
  let isDragging = false;

  function updateVolume(index) {
    const volume = index * 10;
    event.target.setVolume(volume);
    volumeBars.forEach((bar, i) => {
      bar.classList.toggle('active', i <= index);
    });
    updateSpeakerIcon(volume);
  }

  function updateSpeakerIcon(volume) {
    const wave1 = document.getElementById('wave1');
    const wave2 = document.getElementById('wave2');
    const wave3 = document.getElementById('wave3');
    wave1.style.display = volume > 0 ? 'block' : 'none';
    wave2.style.display = volume > 30 ? 'block' : 'none';
    wave3.style.display = volume > 60 ? 'block' : 'none';
  }

  volumeBars.forEach((bar, index) => {
    bar.addEventListener('mousedown', () => {
      isDragging = true;
      updateVolume(index);
    });
    bar.addEventListener('mouseover', () => {
      if (isDragging) {
        updateVolume(index);
      }
    });
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      const rect = document.getElementById('volume-bars').getBoundingClientRect();
      const x = e.clientX - rect.left;
      const barWidth = rect.width / 10;
      const index = Math.min(9, Math.max(0, Math.floor(x / barWidth)));
      updateVolume(index);
    }
  });

  updateVolume(5);

  const syncButton = document.getElementById('sync-button');
  syncButton.addEventListener('click', async () => {
    const { data, error } = await supabaseClient.from('watchparty_sync').select('*').eq('room_id', roomId).single();
    if (data && !error) {
      event.target.seekTo(data.video_time, true);
      if (data.is_playing) {
        event.target.playVideo();
      } else {
        event.target.pauseVideo();
      }
    }
  });

  // 서버 동기화 데이터로 초기 상태 설정
  supabaseClient.from('watchparty_sync').select('*').eq('room_id', roomId).single().then(({ data, error }) => {
    if (data && !error) {
      event.target.seekTo(data.video_time, true);
      if (data.is_playing) {
        event.target.playVideo();
      } else {
        event.target.pauseVideo(); // 명시적으로 일시정지
      }
    } else {
      event.target.pauseVideo(); // 데이터 없으면 기본적으로 일시정지
    }
  });
  // 자막 끄기 초기화
  turnOffCaptions();
  // 주기적으로 자막 끄기 (5초마다)
  setInterval(turnOffCaptions, 5000);
}

function onPlayerStateChange(event) {
  const syncMessage = document.getElementById('sync-message');
  if (event.data === YT.PlayerState.PLAYING) {
    syncMessage.classList.remove('visible');
  } else {
    syncMessage.classList.add('visible');
  }
}

function displayMessage(message) {
  const chatMessages = document.getElementById('chat-messages');
  const div = document.createElement('div');

  if (message.nickname === 'System') {
    div.className = 'system-message';
    div.textContent = `<System: ${message.message_text}>`;
  } else {
    div.textContent = `${message.nickname}: ${message.message_text}`;
  }

  chatMessages.appendChild(div);

  // 사용자가 채팅창 하단 근처에 있는 경우에만 자동 스크롤
  const isNearBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 50;
  if (isNearBottom) {
    chatMessages.scrollTo({
      top: chatMessages.scrollHeight,
      behavior: 'smooth'
    });
  }
}

function extractVideoId(url) {
  const regex = /(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/|live\/))([\w-]{11})/;
  const match = url.match(regex);
  return match ? match[1] : null;
}
  </script>
</body>
</html>